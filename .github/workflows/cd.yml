name: CD

on:
  release:
    types: [ published ]

jobs:
  build:
    name: Build & Publish
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/pypi/codekeeper
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install build
        run: python -m pip install build

      - name: Build package
        run: python -m build

      - name: Verify package
        run: |
          pip install dist/*.whl --force-reinstall
          codekeeper --help

      - name: Publish to Test PyPI
        if: contains(github.ref, 'test') || contains(github.ref, 'rc')
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}

      - name: Publish to PyPI
        if: startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, 'test') && !contains(github.ref, 'rc')
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const { data: release } = await github.rest.repos.getRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.repo.release_id
            });

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const changelog = "## Changes\n\n" +
              "See [CHANGELOG.md](https://github.com/" + owner + "/" + repo + "/blob/main/CHANGELOG.md) for details.\n\n" +
              "## Installation\n\n" +
              "```bash\n" +
              "pip install codekeeper\n" +
              "```\n\n" +
              "## Stats\n\n" +
              "- Downloads: " + (release.downloads || 0) + "\n" +
              "- Created at: " + new Date(release.created_at).toLocaleDateString() + "\n";

            await github.rest.repos.updateRelease({
              owner: owner,
              repo: repo,
              release_id: context.repo.release_id,
              body: changelog
            });

  create-release-notes:
    name: Create Release Notes
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Generate release notes
        uses: actions/github-script@v7
        with:
          script: |
            const { data: commits } = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 50
            });

            const features = [];
            const fixes = [];
            const other = [];

            for (const commit of commits) {
              const msg = commit.commit.message.split('\n')[0].toLowerCase();
              if (msg.includes('feat') || msg.includes('feature')) {
                features.push('- ' + commit.commit.message.split('\n')[0]);
              } else if (msg.includes('fix') || msg.includes('bug')) {
                fixes.push('- ' + commit.commit.message.split('\n')[0]);
              } else if (!msg.includes('merge') && !msg.includes('ci')) {
                other.push('- ' + commit.commit.message.split('\n')[0]);
              }
            }

            let body = '## What\'s Changed\n\n';

            if (features.length > 0) {
              body += '### New Features\n' + features.slice(0, 10).join('\n') + '\n\n';
            }
            if (fixes.length > 0) {
              body += '### Bug Fixes\n' + fixes.slice(0, 10).join('\n') + '\n\n';
            }
            if (other.length > 0) {
              body += '### Other Changes\n' + other.slice(0, 10).join('\n') + '\n';
            }

            body += '\n**Full Changelog**: https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/compare/' + commits[commits.length-1].sha + '...' + commits[0].sha;

            console.log(body);
