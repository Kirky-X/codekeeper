"""APM (Application Performance Monitoring) integration module.

This module provides integration with popular APM systems for
production performance monitoring and observability.
"""

# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the INVALID-LICENSE-TYPE License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author.With.Dots. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author_With_Underscore. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author-With-Hyphen. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author with spaces. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2020-2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test_Author123. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Organization Name. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author <email@example.com>. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the GPL-3.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the BSD-3-Clause License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the Apache-2.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the INVALID-LICENSE-TYPE License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author.With.Dots. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author_With_Underscore. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author-With-Hyphen. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author with spaces. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2020-2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test_Author123. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Organization Name. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author <email@example.com>. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the GPL-3.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the BSD-3-Clause License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the Apache-2.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the INVALID-LICENSE-TYPE License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author.With.Dots. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author_With_Underscore. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author-With-Hyphen. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author with spaces. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2020-2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test_Author123. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Organization Name. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author <email@example.com>. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the GPL-3.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the BSD-3-Clause License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the Apache-2.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the INVALID-LICENSE-TYPE License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author.With.Dots. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author_With_Underscore. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author-With-Hyphen. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author with spaces. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2020-2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test_Author123. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Organization Name. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author <email@example.com>. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the GPL-3.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the BSD-3-Clause License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the Apache-2.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the INVALID-LICENSE-TYPE License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author.With.Dots. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author_With_Underscore. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author-With-Hyphen. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author with spaces. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2020-2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test_Author123. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Organization Name. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author <email@example.com>. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the GPL-3.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the BSD-3-Clause License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the Apache-2.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the INVALID-LICENSE-TYPE License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author.With.Dots. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author_With_Underscore. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author-With-Hyphen. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author with spaces. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2020-2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test_Author123. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Organization Name. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author <email@example.com>. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the GPL-3.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the BSD-3-Clause License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the Apache-2.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the INVALID-LICENSE-TYPE License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author.With.Dots. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author_With_Underscore. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author-With-Hyphen. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author with spaces. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2020-2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test_Author123. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Organization Name. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author <email@example.com>. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the GPL-3.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the BSD-3-Clause License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the Apache-2.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the INVALID-LICENSE-TYPE License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author.With.Dots. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author_With_Underscore. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author-With-Hyphen. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author with spaces. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2020-2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test_Author123. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Organization Name. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author <email@example.com>. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the GPL-3.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the BSD-3-Clause License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the Apache-2.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the INVALID-LICENSE-TYPE License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author.With.Dots. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author_With_Underscore. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author-With-Hyphen. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author with spaces. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2015 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2020-2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test_Author123. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Organization Name. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author <email@example.com>. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the GPL-3.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the BSD-3-Clause License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the Apache-2.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the INVALID-LICENSE-TYPE License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author.With.Dots. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author_With_Underscore. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author-With-Hyphen. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author with spaces. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2015 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2020-2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test_Author123. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Organization Name. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author <email@example.com>. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the GPL-3.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the BSD-3-Clause License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the Apache-2.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the INVALID-LICENSE-TYPE License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author.With.Dots. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author_With_Underscore. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author-With-Hyphen. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author with spaces. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2015 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2020-2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test_Author123. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Organization Name. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author <email@example.com>. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the GPL-3.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the BSD-3-Clause License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the Apache-2.0 License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2025 Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


# Copyright (c) 2024-2025 Test Author. All rights reserved.
# Licensed under the MIT License.
# See LICENSE file in the project root for full license information.


import logging
import threading
import time
from abc import ABC, abstractmethod
from contextlib import contextmanager
from dataclasses import dataclass
from datetime import datetime
from enum import Enum
from typing import Any

from codekeeper.infra.metrics import (
    get_monitor,
)

logger = logging.getLogger(__name__)


class APMVendor(Enum):
    DATADOG = "datadog"
    NEW_RELIC = "new_relic"
    PROMETHEUS = "prometheus"
    OPENTELEMETRY = "opentelemetry"
    SKY_WALKING = "skywalking"
    CUSTOM = "custom"


@dataclass
class Span:
    trace_id: str
    span_id: str
    parent_span_id: str | None
    operation_name: str
    start_time: datetime
    end_time: datetime | None
    duration_ms: float
    tags: dict[str, str]
    logs: list[dict[str, Any]]
    status: str
    error_message: str | None

    def to_dict(self) -> dict[str, Any]:
        return {
            "trace_id": self.trace_id,
            "span_id": self.span_id,
            "parent_span_id": self.parent_span_id,
            "operation_name": self.operation_name,
            "start_time": self.start_time.isoformat(),
            "end_time": self.end_time.isoformat() if self.end_time else None,
            "duration_ms": round(self.duration_ms, 2),
            "tags": self.tags,
            "logs": self.logs,
            "status": self.status,
            "error_message": self.error_message,
        }


@dataclass
class Trace:
    trace_id: str
    spans: list[Span]
    start_time: datetime
    end_time: datetime | None
    duration_ms: float
    service_name: str

    def to_dict(self) -> dict[str, Any]:
        return {
            "trace_id": self.trace_id,
            "service_name": self.service_name,
            "start_time": self.start_time.isoformat(),
            "end_time": self.end_time.isoformat() if self.end_time else None,
            "duration_ms": round(self.duration_ms, 2),
            "spans": [span.to_dict() for span in self.spans],
        }


class APMClient(ABC):
    """Abstract base class for APM clients."""

    @abstractmethod
    def start_span(
            self,
            _operation_name: str,
            _tags: dict[str, str] | None = None,
            _parent_span_id: str | None = None,
    ) -> str:
        """Start a new span and return span ID.

        Args:
            operation_name: Name of the operation
            tags: Optional tags for the span
            parent_span_id: ID of parent span

        Returns:
            Span ID
        """
        pass

    @abstractmethod
    def end_span(
            self,
            span_id: str,
            status: str = "ok",
            error_message: str | None = None,
            logs: list[dict[str, Any]] | None = None,
    ) -> None:
        """End a span.

        Args:
            span_id: ID of the span to end
            status: Status of the span (ok, error, timeout)
            error_message: Error message if status is error
            logs: Additional logs for the span
        """
        pass

    @abstractmethod
    def record_metric(self, name: str, value: float, tags: dict[str, str] | None = None) -> None:
        """Record a custom metric.

        Args:
            name: Metric name
            value: Metric value
            tags: Optional tags
        """
        pass

    @abstractmethod
    def flush(self) -> None:
        """Flush all pending data to the APM service."""
        pass


class DatadogAPMClient(APMClient):
    """Datadog APM client implementation."""

    def __init__(
            self,
            api_key: str | None = None,
            app_key: str | None = None,
            site: str = "datadoghq.com",
            service_name: str = "codekeeper",
    ):
        """Initialize Datadog APM client.

        Args:
            api_key: Datadog API key
            app_key: Datadog APP key
            site: Datadog site (datadoghq.com, us3.datadoghq.com, etc.)
            service_name: Name of the service
        """
        self.api_key = api_key
        self.app_key = app_key
        self.site = site
        self.service_name = service_name
        self._spans: list[Span] = []
        self._metrics: list[dict[str, Any]] = []
        self._current_span_id = 0
        self._lock = threading.Lock()

    def _generate_span_id(self) -> str:
        self._current_span_id += 1
        return str(self._current_span_id)

    def start_span(
            self,
            _operation_name: str,
            _tags: dict[str, str] | None = None,
            _parent_span_id: str | None = None,
    ) -> str:
        span_id = self._generate_span_id()
        span = Span(
            trace_id="",
            span_id=span_id,
            parent_span_id=_parent_span_id,
            operation_name=_operation_name,
            start_time=datetime.now(),
            end_time=None,
            duration_ms=0.0,
            tags=_tags or {},
            logs=[],
            status="started",
            error_message=None,
        )
        with self._lock:
            self._spans.append(span)
        return span_id

    def end_span(
            self,
            span_id: str,
            status: str = "ok",
            error_message: str | None = None,
            logs: list[dict[str, Any]] | None = None,
    ) -> None:
        with self._lock:
            for span in self._spans:
                if span.span_id == span_id:
                    span.end_time = datetime.now()
                    span.duration_ms = (span.end_time - span.start_time).total_seconds() * 1000
                    span.status = status
                    span.error_message = error_message
                    if logs:
                        span.logs.extend(logs)
                    break

    def record_metric(self, name: str, value: float, tags: dict[str, str] | None = None) -> None:
        metric = {
            "metric": name,
            "points": [(time.time(), value)],
            "tags": [f"{k}:{v}" for k, v in (tags or {}).items()],
            "type": "gauge",
            "host": "",
            "device": "",
        }
        with self._lock:
            self._metrics.append(metric)

    def flush(self) -> None:
        logger.info(
            f"Flushing {len(self._spans)} spans and {len(self._metrics)} metrics to Datadog"
        )

    def get_traces(self) -> list[Span]:
        with self._lock:
            return self._spans.copy()

    def get_metrics(self) -> list[dict[str, Any]]:
        with self._lock:
            return self._metrics.copy()


class PrometheusAPMClient(APMClient):
    """Prometheus metrics exporter for APM."""

    def __init__(self, service_name: str = "codekeeper"):
        """Initialize Prometheus APM client.

        Args:
            service_name: Name of the service
        """
        self.service_name = service_name
        self._metrics: dict[str, list[tuple]] = {}
        self._lock = threading.Lock()

    def start_span(
            self,
            operation_name: str,
            tags: dict[str, str] | None = None,
            parent_span_id: str | None = None,
    ) -> str:
        return self._generate_id()

    def _generate_id(self) -> str:
        import uuid

        return str(uuid.uuid4())[:8]

    def end_span(
            self,
            span_id: str,
            status: str = "ok",
            error_message: str | None = None,
            logs: list[dict[str, Any]] | None = None,
    ) -> None:
        pass

    def record_metric(self, name: str, value: float, _tags: dict[str, str] | None = None) -> None:
        key = f"{self.service_name}_{name}"

        with self._lock:
            if key not in self._metrics:
                self._metrics[key] = []
            self._metrics[key].append((time.time(), value))

    def flush(self) -> None:
        pass

    def get_metrics(self) -> str:
        with self._lock:
            lines = []
            for name, values in self._metrics.items():
                for timestamp, value in values:
                    lines.append(f"# TYPE {name} gauge")
                    lines.append(f"{name} {value} {int(timestamp * 1000)}")
            return "\n".join(lines)


class OpenTelemetryAPMClient(APMClient):
    """OpenTelemetry collector client."""

    def __init__(
            self,
            endpoint: str | None = None,
            service_name: str = "codekeeper",
            headers: dict[str, str] | None = None,
    ):
        """Initialize OpenTelemetry client.

        Args:
            endpoint: OTLP endpoint URL
            service_name: Name of the service
            headers: Additional headers for the collector
        """
        self.endpoint = endpoint
        self.service_name = service_name
        self.headers = headers or {}
        self._spans: list[Span] = []
        self._metrics: list[dict[str, Any]] = []
        self._lock = threading.Lock()
        self._trace_id_counter = 0

    def _generate_trace_id(self) -> str:
        self._trace_id_counter += 1
        return f"trace-{self._trace_id_counter:08x}"

    def _generate_span_id(self) -> str:
        import uuid

        return uuid.uuid4().hex[:16]

    def start_span(
            self,
            operation_name: str,
            tags: dict[str, str] | None = None,
            parent_span_id: str | None = None,
    ) -> str:
        trace_id = self._generate_trace_id()
        span_id = self._generate_span_id()

        span = Span(
            trace_id=trace_id,
            span_id=span_id,
            parent_span_id=parent_span_id,
            operation_name=operation_name,
            start_time=datetime.now(),
            end_time=None,
            duration_ms=0.0,
            tags=tags or {"service.name": self.service_name},
            logs=[],
            status="started",
            error_message=None,
        )

        with self._lock:
            self._spans.append(span)

        return span_id

    def end_span(
            self,
            span_id: str,
            status: str = "ok",
            error_message: str | None = None,
            logs: list[dict[str, Any]] | None = None,
    ) -> None:
        with self._lock:
            for span in self._spans:
                if span.span_id == span_id:
                    span.end_time = datetime.now()
                    span.duration_ms = (span.end_time - span.start_time).total_seconds() * 1000
                    span.status = status
                    span.error_message = error_message
                    if logs:
                        span.logs.extend(logs)
                    break

    def record_metric(self, name: str, value: float, tags: dict[str, str] | None = None) -> None:
        metric = {
            "name": name,
            "value": value,
            "timestamp": time.time(),
            "attributes": tags or {},
        }
        with self._lock:
            self._metrics.append(metric)

    def flush(self) -> None:
        logger.info(
            f"Flushing {len(self._spans)} spans to OpenTelemetry collector at {self.endpoint}"
        )

    def get_traces(self) -> list[Span]:
        with self._lock:
            return self._spans.copy()


class APMIntegration:
    """Central APM integration manager."""

    def __init__(
            self,
            vendor: APMVendor = APMVendor.CUSTOM,
            service_name: str = "codekeeper",
            enabled: bool = True,
    ):
        """Initialize APM integration.

        Args:
            vendor: APM vendor to use
            service_name: Name of the service
            enabled: Whether APM is enabled
        """
        self.vendor = vendor
        self.service_name = service_name
        self.enabled = enabled
        self._client: APMClient | None = None
        self._monitor = get_monitor()
        self._span_stack: list[str] = []
        self._current_trace_id: str | None = None
        self._lock = threading.Lock()

    def initialize(self, config: dict[str, Any]) -> None:
        """Initialize the APM client.

        Args:
            config: Configuration dictionary for the APM client
        """
        if not self.enabled:
            logger.info("APM integration is disabled")
            return

        if self.vendor == APMVendor.DATADOG:
            self._client = DatadogAPMClient(
                api_key=config.get("api_key"),
                app_key=config.get("app_key"),
                site=config.get("site", "datadoghq.com"),
                service_name=self.service_name,
            )
        elif self.vendor == APMVendor.PROMETHEUS:
            self._client = PrometheusAPMClient(service_name=self.service_name)
        elif self.vendor == APMVendor.OPENTELEMETRY:
            self._client = OpenTelemetryAPMClient(
                endpoint=config.get("endpoint"),
                service_name=self.service_name,
                headers=config.get("headers"),
            )
        elif self.vendor == APMVendor.CUSTOM:
            self._client = self._create_custom_client(config)
        else:
            logger.warning(f"Unsupported APM vendor: {self.vendor}")

        if self._client:
            logger.info(f"APM integration initialized with vendor: {self.vendor.value}")

    def _create_custom_client(self, config: dict[str, Any]) -> APMClient | None:
        """Create custom APM client from configuration.

        Args:
            config: Configuration dictionary

        Returns:
            Custom APM client or None
        """
        client_class = config.get("client_class")
        if client_class and callable(client_class):
            try:
                return client_class(**config.get("client_config", {}))
            except Exception as e:
                logger.error(f"Failed to create custom APM client: {e}")
        return None

    def start_trace(self, operation_name: str, tags: dict[str, str] | None = None) -> str:
        """Start a new trace.

        Args:
            operation_name: Name of the operation
            tags: Optional tags for the trace

        Returns:
            Trace ID
        """
        if not self.enabled or not self._client:
            return ""

        import uuid

        self._current_trace_id = str(uuid.uuid4())

        span_id = self._client.start_span(
            operation_name=operation_name,
            tags=tags,
            parent_span_id=None,
        )

        with self._lock:
            self._span_stack.append(span_id)

        return self._current_trace_id

    def end_trace(
            self,
            _trace_id: str,
            status: str = "ok",
            error_message: str | None = None,
    ) -> None:
        """End a trace.

        Args:
            trace_id: ID of the trace to end
            status: Status of the trace
            error_message: Error message if status is error
        """
        if not self.enabled or not self._client:
            return

        while self._span_stack:
            span_id = self._span_stack.pop()
            self._client.end_span(
                span_id=span_id,
                status=status,
                error_message=error_message,
            )

        self._current_trace_id = None

    @contextmanager
    def trace_operation(self, operation_name: str, tags: dict[str, str] | None = None):
        """Context manager for tracing an operation.

        Args:
            operation_name: Name of the operation
            tags: Optional tags for the trace

        Yields:
            Trace context
        """
        trace_id = self.start_trace(operation_name, tags)
        try:
            yield trace_id
            self.end_trace(trace_id, status="ok")
        except Exception as e:
            self.end_trace(trace_id, status="error", error_message=str(e))
            raise

    def sync_performance_metrics(self) -> None:
        """Synchronize performance monitor metrics to APM.

        This method collects metrics from the PerformanceMonitor and
        sends them to the configured APM backend.
        """
        if not self.enabled or not self._client:
            return

        summary = self._monitor.get_summary()

        for op_metric in summary.get("operations", []):
            self._client.record_metric(
                name="operation_duration_ms",
                value=op_metric.get("avg_duration_ms", 0),
                tags={
                    "operation": op_metric.get("operation_name", "unknown"),
                    "status": "success" if op_metric.get("error_count", 0) == 0 else "error",
                },
            )

            self._client.record_metric(
                name="operation_count",
                value=op_metric.get("call_count", 0),
                tags={"operation": op_metric.get("operation_name", "unknown")},
            )

            self._client.record_metric(
                name="operation_errors",
                value=op_metric.get("error_count", 0),
                tags={"operation": op_metric.get("operation_name", "unknown")},
            )

        system_metrics = summary.get("system", {})
        if memory := system_metrics.get("memory"):
            self._client.record_metric(
                name="memory_rss_mb",
                value=memory.get("rss_mb", 0),
                tags={},
            )

        if cpu := system_metrics.get("cpu"):
            self._client.record_metric(
                name="cpu_percent",
                value=cpu.get("cpu_percent", 0),
                tags={},
            )

        logger.debug("Performance metrics synchronized to APM")

    def flush(self) -> None:
        """Flush all pending data to the APM service."""
        if self._client:
            self.sync_performance_metrics()
            self._client.flush()

    def get_report(self) -> dict[str, Any]:
        """Get APM report with all collected data.

        Returns:
            Dictionary with APM report data
        """
        report = {
            "service_name": self.service_name,
            "vendor": self.vendor.value,
            "enabled": self.enabled,
            "performance_summary": self._monitor.get_summary(),
        }

        if self._client:
            if hasattr(self._client, "get_traces"):
                report["traces"] = [s.to_dict() for s in self._client.get_traces()]
            if hasattr(self._client, "get_metrics"):
                if isinstance(self._client, PrometheusAPMClient):
                    report["prometheus_metrics"] = self._client.get_metrics()
                else:
                    report["metrics"] = self._client.get_metrics()

        return report

    def reset(self) -> None:
        """Reset all APM data."""
        self._monitor.reset()
        self._span_stack.clear()
        self._current_trace_id = None
        logger.info("APM integration reset")


def apm_trace(
        operation_name: str,
        tags: dict[str, str] | None = None,
        apm_integration: APMIntegration | None = None,
):
    """Decorator for tracing function execution.

    Args:
        operation_name: Name for the traced operation
        tags: Optional tags for the trace
        apm_integration: APM integration instance (uses global if None)

    Returns:
        Decorator function
    """

    def decorator(func):
        import asyncio

        async def async_wrapper(*args, **kwargs):
            integration = apm_integration if apm_integration is not None else get_apm_integration()
            with integration.trace_operation(operation_name, tags):
                return await func(*args, **kwargs)

        def sync_wrapper(*args, **kwargs):
            integration = apm_integration if apm_integration is not None else get_apm_integration()
            with integration.trace_operation(operation_name, tags):
                return func(*args, **kwargs)

        if asyncio.iscoroutinefunction(func):
            return async_wrapper
        return sync_wrapper

    return decorator


_default_apm_integration: APMIntegration | None = None


def get_apm_integration(
        vendor: APMVendor = APMVendor.CUSTOM,
        service_name: str = "codekeeper",
        enabled: bool = True,
) -> APMIntegration:
    """Get the global APM integration instance.

    Args:
        vendor: APM vendor to use
        service_name: Name of the service
        enabled: Whether APM is enabled

    Returns:
        APMIntegration instance
    """
    global _default_apm_integration
    if _default_apm_integration is None:
        _default_apm_integration = APMIntegration(
            vendor=vendor,
            service_name=service_name,
            enabled=enabled,
        )
    return _default_apm_integration


def sync_to_apm() -> None:
    """Convenience function to sync performance metrics to APM."""
    apm = get_apm_integration()
    apm.sync_performance_metrics()
